<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>会议室信息编辑</title>
    <link rel="icon" href="../../assets/images/favicon.ico"/>
    <link rel="stylesheet" href="../../assets/libs/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../assets/common.css" media="all">
</head>
<body>
<div class="layui-container">
    <div class="layui-form-item" style="margin-top: 10px">

     <!--    <div class="layui-inline">
            <label class="layui-form-label">设备名称</label>
            <div class="layui-input-inline" style="width: 200px;">
                <input type="text"  id="departmentName" required lay-verify="required" placeholder="请输入设备名称" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <button class="layui-btn  layui-btn-normal" id="searchDataBtn">
                <i class="layui-icon layui-icon-search"></i> 搜索
            </button>
        </div> -->
         <span style="color: #0C0C0C;font-style: normal;font-size: 30px">会议室信息编辑</span>
         <br />
         
         <form class="layui-form" action="" style="margin-top: 10px">
              <div class="layui-form-item">
                    <label class="layui-form-label">会议室名称</label>
                    <div class="layui-input-block">
                         <input type="text" name="meetingRoomName" id="meetingRoomName" style= "width: 150px;" required  lay-verify="required" placeholder="请输入名称" autocomplete="off" class="layui-input">
                    </div>
              </div>
              <div class="layui-form-item">
                    <label class="layui-form-label">容纳人数</label>
                    <div class="layui-input-block">
                         <input type="text" name="meetingRoomPeoples" id="meetingRoomPeoples" style= "width: 150px;"  required  lay-verify="required|number"  placeholder="请输入人数"  autocomplete="off" class="layui-input">
                    </div>
              </div>
         </form>
         <!-- 图片 -->
   <!--       <div class="layui-form-item">
                    <label class="layui-form-label">会议室图片</label>
                    <div class="layui-input-block">
                         <input type="text" name="meetingRoomPeoples" id="meetingRoomPeoples" style= "width: 150px;"  required  lay-verify="required|number"  placeholder="请输入人数"  autocomplete="off" class="layui-input">
                    </div>
              </div>
 -->
         <div class="layui-form-item">
                <label class="layui-form-label">设备</label>
                <div class="layui-input-block">
                     <table id="equimentsTable" lay-filter="equimentsTable"></table>
                </div>
	 	 </div>

        <div class="layui-inline" style="margin-top: 50px">
                <div class="layui-container">
                      <div class="layui-row">
                                <div class="layui-col-md9">
                                  &emsp;
                                </div>
                                <div class="layui-col-md3">
                                        <button class="layui-btn  layui-btn-normal" id="meetingRoomBackBtn">
                                             <i class="layui-icon">&#x21b6;</i> 返回
                                        </button>
                                        <button class="layui-btn  layui-btn-normal" id="meetingRoomAddBtn" lay-filter="meetingRoomFormSubmit" lay-submit>
                                             <i class="layui-icon"></i> 保存
                                        </button>
                                </div>
                      </div>
                </div>
        </div>
    </div>
</div>

<!-- 设备选择器 -->

<script type="text/html" id="toolTableBar">
{{# if (d.index == 0 ){ }}
    <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="add">
      <i class="layui-icon">&#xe654;</i>
    </button>
{{# } else { }}
  <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="edit">
      <i class="layui-icon">&#xe642;</i>
    </button>
    <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="del">
      <i class="layui-icon">&#xe640;</i>
    </button>
{{# } }}
</script>

<!-- 添加设备 对话框 -->
<script type="text/html"  id="equipmentAddDialog">
<form class="layui-form" action=""  lay-filter="equittmentEidt">
        <div class="layui-form-item">
            <label class="layui-form-label">设备</label>
            <div class="layui-input-block"  id="equimentSelId" lay-filter="equimentSelId" name="departmentId" > </div>
        </div>
		<div class="layui-form-item">
           <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
              <input type="text" name="counts" id="counts" required  lay-verify="required|number" placeholder="请输入设备数量"   autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="equipmentFormSubmit" lay-submit>保存</button>
        </div>
</form>
</script>

<!-- 修改对话框 -->

<script type="text/html"  id="equittmentEidtDialog">
<form class="layui-form" action=""  lay-filter="equittmentEidt">
        <div class="layui-form-item">
            <label class="layui-form-label">部门</label>
            <div class="layui-input-block"  id="equimentSelId" lay-filter="equimentSelId" name="departmentId" > </div>
        </div>
		<div class="layui-form-item">
           <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
              <input type="text" name="counts" required  lay-verify="required|number" placeholder="请输入设备数量"   autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="equittmentEidtFormSubmit" lay-submit>保存</button>
        </div>
</form>
</script>

<!-- js 部分 -->
<script type="text/javascript" src="../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../assets/common.js"></script>
<script type="text/javascript" src="../../assets/module/selectPlus.js"></script>
<script type="text/javascript" src="../../assets/module/getUrlParam.js"></script> 
<script type="text/javascript">
    console.log(UrlParam.paramValues('meetRoomId'))
    layui.use(['form','layer','admin','jquery', 'table', 'selectPlus'], function () {
    	var $ = layui.jquery
        var admin = layui.admin
        var form = layui.form
        var table = layui.table
        var selectPlus = layui.selectPlus
        var equiments = [{
        	equimentId: null,
        	equipmentName: '',
        	counts: null,
        	index: 0
        }]
    	var equimentSels = []
        // 返回按钮操作
        $('#meetingRoomBackBtn').click(function(){
        	location.replace('meetingroom.html');
        })
        // 获取设备单选数据
        admin.req('equipment/getEquipmentAll', {},function(res){
        	equimentSels = res.data
        }, 'POST' )
        // 渲染表格数据
        table.render({
            elem: '#equimentsTable'
            ,data: equiments
            ,cols: [[ //表头
            	{type: 'numbers'}
            	,{field: 'equimentId', title: 'ID', sort: true}
               ,{field: 'equipmentName', title: '设备名称'}
               ,{field: 'counts', title: '数量',  sort: true}
               , {align: 'center', toolbar: '#toolTableBar', title: '操作', unresize: true, width: 200}
            ]]
          })
       
        // 保存操作
        form.on('submit(meetingRoomFormSubmit)', function(data){
            var meetingRoomName = $('#meetingRoomName').val()
            var meetingRoomPeoples = $('#meetingRoomPeoples').val()
            if (meetingRoomName === undefined || meetingRoomName === '') {
                layer.msg('会议室名称不能为空')
                return false
            }
            if (meetingRoomPeoples === undefined || meetingRoomPeoples === '') {
                layer.msg('容纳人数不能为空')
                return false
            }
            console.log(meetingRoomPeoples)
            if (!new RegExp('^[0-9]*$').test (meetingRoomPeoples)) {
                layer.msg('容纳人数，请输入数字')
                return false
            }
            var pram = {
                meetingRoomName: meetingRoomName,
                meetingRoomPeoples: meetingRoomPeoples,
                roomEquiments: equiments
            }
        	console.log(pram)
        	admin.feacth('meetingroom/insertMeetingRoom', pram, 'application/json; charset=UTF-8', function(res){
        		if (res.code === 200 ) {
        			layer.msg(res.msg, {icon: 1})
                    location.replace('meetingroom.html')
        		} else {
                    layer.msg(res.msg, {icon: 2})
        		}

        	}, 'POST')
        	return false;
        })
        // 监听事件
        table.on('tool(equimentsTable)', function(obj){
          var index = obj.tr.selector.replace(/[^0-9]/ig, "")
          switch(obj.event){
            case 'add':
            	layer.open({
	           		title: '添加设备数量',
	           		content: $('#equipmentAddDialog').html(),
	           		btn:[],
	           		success: function(layero, index){
	           		  // 设备单选框
	                   selectPlus.render({
	                      el: '#equimentSelId',
	                      data: equimentSels,
	                      type: "radio",
	                      valueName: "equipmentName",
	                      label: ["equipmentName"],
	                      values: 'no'
	                    })
	                    var  equipmentName = '', id = ''
	                    // 监听单选框
	                     selectPlus.on('selectPlus(equimentSelId)', function(obj){  
						// 单选时
							equipmentName = obj.value
							id = obj.checkedData.id
						});
	                    //监听提交
		              	  form.on('submit(equipmentFormSubmit)', function(data){
		              		equiments.push({
		              			equimentId: id,
		                      	equipmentName: equipmentName,
		                      	counts: data.field.counts,
		                      	index: 0
		              		})
		              		equiments[equiments.length - 1].index = 1
		              		// 关闭对话框
		              		layer.close(layer.index)
		              		table.reload('equimentsTable', {data: equiments})
		              	    return false;
		              	  });
	                    
	           		 }
            	})
            break;
            	
            	
            case 'del':
            	equiments.splice(index,1)   //删除
            	table.reload('equimentsTable', {data: equiments})
            break;
            
            
            case 'edit':
            	var valuesSel = equiments[index].equipmentName
            	layer.open({
	           		title: '修改设备数量',
	           		content: $('#equittmentEidtDialog').html(),
	           		btn:[],
	           		success: function(layero){
	           		 // 设备单选框
		               selectPlus.render({
		                  el: '#equimentSelId',
		                  data: equimentSels,
		                  type: "radio",
		                  valueName: "equipmentName",
		                  label: ["equipmentName"],
		                  values: valuesSel
		                })
		                var  equipmentName = valuesSel, id = equiments[index].id
		                // 监听单选框
		                selectPlus.on('selectPlus(equimentSelId)', function(obj){  
						// 单选时
							equipmentName = obj.value
							id = obj.checkedData.id
						})
						//监听提交
		              	  form.on('submit(equittmentEidtFormSubmit)', function(data){
		              		equiments[index].equimentId = id
		              		equiments[index].equipmentName = equipmentName
		              		equiments[index].counts = data.field.counts
		              		// 关闭对话框
		              		layer.close(layer.index)
		              		table.reload('equimentsTable', {data: equiments})
		              	    return false;
		              	  });
	                    
	           		}
            	})
            	form.val("equittmentEidt", {
            		  'counts': equiments[index].counts
            	})
            		
            break;
          };
        });
    })
</script>

</body>
</html>